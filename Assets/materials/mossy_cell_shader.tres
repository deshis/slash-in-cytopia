[gd_resource type="ShaderMaterial" format=3 uid="uid://5l1ixy8by66k"]

[ext_resource type="Texture2D" uid="uid://dp2qderulb6q" path="res://Assets/apollo-8x.png" id="2_4eh1c"]

[sub_resource type="Shader" id="Shader_et1gd"]
code = "shader_type spatial;
render_mode specular_disabled;

uniform sampler2D base_texture : source_color;
uniform sampler2D moss_texture : source_color;
uniform sampler2D noise_texture : source_color;

uniform float noise_scale = 4.0;
uniform float moss_threshold = 0.4;
uniform float upward_bias = 0.4;

uniform float light_steps = 3.0;

varying float occlusion;
varying vec3 world_pos;
varying vec3 world_normal;

void vertex() {
    world_pos = (MODEL_MATRIX * vec4(VERTEX, 1.0)).xyz;
    world_normal = normalize((MODEL_MATRIX * vec4(NORMAL, 0.0)).xyz);
}

void fragment() {
	occlusion = round(COLOR.r * light_steps) / light_steps; // Using vertex color for additional shadows
	

	float dir_bias = dot(world_normal, vec3(0.0, 1.0, 0.0));
	// Lift walls, reward tops
	float up_bias = dir_bias * upward_bias + (1.0-upward_bias);
	// Kill undersides
	up_bias *= smoothstep(-0.2, 0.1, dir_bias);
	// Clamp for safety
	up_bias = clamp(up_bias, 0.0, 1.0);
	
	vec3 n = abs(world_normal);
	n = pow(n, vec3(4.0));
	n /= (n.x + n.y + n.z);

	// Triplanar noise
	float noise_x = texture(noise_texture, world_pos.yz * noise_scale).r;
	float noise_y = texture(noise_texture, world_pos.xz * noise_scale).r;
	float noise_z = texture(noise_texture, world_pos.xy * noise_scale).r;

	float noise =
	    noise_x * n.x +
	    noise_y * n.y +
	    noise_z * n.z;

	// Bias
	float biased_noise = noise * up_bias;
    // Threshold after bias
    float moss_mask = smoothstep(moss_threshold, moss_threshold, biased_noise);

	
	vec3 base = texture(base_texture, UV).rgb;
	vec3 moss = texture(moss_texture, UV).rgb;
	
	ALBEDO = mix(base, moss, moss_mask);
}

void light() {
	float light = clamp(dot(NORMAL, LIGHT), 0.0, 1.0);
	light = ceil(light * light_steps) / light_steps;
	DIFFUSE_LIGHT += light * ATTENUATION * occlusion * LIGHT_COLOR / PI;
}
"

[sub_resource type="Gradient" id="Gradient_skwgt"]
colors = PackedColorArray(0.4341572, 0.62295854, 0.16561797, 1, 0.5048625, 0.6043732, 0.12463064, 1)

[sub_resource type="GradientTexture1D" id="GradientTexture1D_6m62q"]
gradient = SubResource("Gradient_skwgt")

[sub_resource type="FastNoiseLite" id="FastNoiseLite_b35cf"]
noise_type = 0

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_4eh1c"]
noise = SubResource("FastNoiseLite_b35cf")
seamless = true

[resource]
render_priority = 0
shader = SubResource("Shader_et1gd")
shader_parameter/base_texture = ExtResource("2_4eh1c")
shader_parameter/moss_texture = SubResource("GradientTexture1D_6m62q")
shader_parameter/noise_texture = SubResource("NoiseTexture2D_4eh1c")
shader_parameter/noise_scale = 0.041
shader_parameter/moss_threshold = 0.364
shader_parameter/upward_bias = 0.006
shader_parameter/light_steps = 3.0
